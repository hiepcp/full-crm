<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Azure AD Login Tester</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:;">
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
    button { padding: 10px 16px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; }
    #log { white-space: pre-wrap; background: #f7f7f9; padding: 12px; border-radius: 8px; border: 1px solid #eee; margin-top: 16px; }
    code { background: #f1f1f4; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Test nháº­n <code>access_token</code> qua <code>postMessage</code></h1>
  <p>
    File nÃ y sáº½ má»Ÿ popup Ä‘Äƒng nháº­p Azure AD vÃ  chá» nháº­n message tá»«
    <code>/signin-oidc</code> cá»§a báº¡n.
  </p>

  <button id="btnLogin">ÄÄƒng nháº­p Azure AD</button>

  <div id="log"></div>

  <script>
    // ====== Cáº¦N CHá»ˆNH Sá»¬A á» ÄÃ‚Y ======
    const TENANT_ID    = "f286906e-f0af-4d95-8ac0-76cbdfb897fa";
    const CLIENT_ID    = "badc369f-3f7a-4da3-8690-4b26f3908070";
    const REDIRECT_URI = "https://api-authn-dev.response.com.vn:7016/signin-oidc";
    const SCOPES       = "openid profile email offline_access"; // muá»‘n refresh_token thÃ¬ giá»¯ offline_access
    const STATE        = "123456"; // tuá»³ Ã½, Ä‘á»ƒ check CSRF
    // Origin cá»§a BE tráº£ postMessage (nÃªn khá»›p vá»›i domain cá»§a REDIRECT_URI).
    // Náº¿u backend báº¡n dÃ¹ng '*' thÃ¬ váº«n nÃªn tá»± kiá»ƒm tra cho an toÃ n:
    const ALLOWED_ORIGIN = new URL(REDIRECT_URI).origin;

    // ====== Helper log ======
    const $log = document.getElementById("log");
    function log(msg) {
      console.log(msg);
      $log.textContent += (typeof msg === "string" ? msg : JSON.stringify(msg, null, 2)) + "\n";
    }

    // ====== XÃ¢y URL authorize ======
    function buildAuthorizeUrl() {
      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        response_type: "code",
        redirect_uri: REDIRECT_URI,
        response_mode: "query",
        scope: SCOPES,
        state: STATE
      });
      return `https://login.microsoftonline.com/${TENANT_ID}/oauth2/v2.0/authorize?${params.toString()}`;
    }

    let popup = null;
    let popupTimer = null;

    // Nháº­n message tá»« /signin-oidc (window.opener.postMessage)
    window.addEventListener("message", (event) => {
      try {
        // Kiá»ƒm tra origin
        if (event.origin !== ALLOWED_ORIGIN) {
          log(`Bá» qua message tá»« origin khÃ´ng há»£p lá»‡: ${event.origin}`);
          return;
        }

        // event.data dá»± kiáº¿n: { access_token: "...", expires_in: 3600 }
        log("ÄÃ£ nháº­n message tá»« popup:");
        log(event.data);

        // In ra console riÃªng access_token
        if (event.data && event.data.access_token) {
          console.log("ACCESS TOKEN:", event.data.access_token);
          log("ACCESS TOKEN (console cÅ©ng Ä‘Ã£ in): " + event.data.access_token);
        } else {
          log("KhÃ´ng cÃ³ access_token trong payload!");
        }
      } catch (e) {
        log("Lá»—i xá»­ lÃ½ message: " + e.message);
      } finally {
        if (popup && !popup.closed) popup.close();
        if (popupTimer) clearInterval(popupTimer);
      }
    });

    function startLogin() {
      const url = buildAuthorizeUrl();
      log("Má»Ÿ popup Ä‘áº¿n:\n" + url);

      popup = window.open(
        url,
        "azuread_login",
        "width=500,height=650,menubar=no,toolbar=no,location=no,status=no"
      );

      if (!popup) {
        log("ğŸ¯ TrÃ¬nh duyá»‡t cháº·n popup. HÃ£y báº­t cho phÃ©p popup hoáº·c giá»¯ nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ má»Ÿ láº¡i.");
        return;
      }

      // Poll xem user cÃ³ Ä‘Ã³ng popup khÃ´ng
      popupTimer = setInterval(() => {
        if (popup.closed) {
          clearInterval(popupTimer);
          log("Popup Ä‘Ã£ Ä‘Ã³ng.");
        }
      }, 500);
    }

    document.getElementById("btnLogin").addEventListener("click", startLogin);

    // Tá»± Ä‘á»™ng cháº¡y luÃ´n khi má»Ÿ file (náº¿u popup bá»‹ cháº·n, báº¥m nÃºt)
    window.addEventListener("load", () => {
      startLogin();
    });
  </script>
</body>
</html>
