# API Contract: File Retrieval Endpoint

**Feature**: 004-fix-sharepoint-file-preview
**Endpoint**: `GET /api/files/{idRef}`
**Version**: 1.0
**Date**: 2025-12-24

## Overview

Retrieve a temporary signed URL for accessing a file stored in SharePoint by its IdRef identifier. The signed URL is generated by Microsoft Graph API and expires in approximately 1 hour.

## Authentication

**Required**: Yes

**Headers**:
```http
Authorization: Bearer <jwt_token>
XApiKey: <api_key>
```

**Description**: Both JWT token (from login) and API key are required for all requests to the CRM API.

## Endpoint Details

### Request

**Method**: `GET`

**URL**: `/api/files/{idRef}`

**Path Parameters**:

| Parameter | Type | Required | Description | Example |
|-----------|------|----------|-------------|---------|
| `idRef` | string | Yes | SharePoint file identifier from `crm_activity_attachment.IdRef` | `01ABCDEF12345GHIJ67890KLMNO` |

**Query Parameters**: None

**Request Body**: None

**Example Request**:
```http
GET /api/files/01ABCDEF12345GHIJ67890KLMNO HTTP/1.1
Host: api-crm.local.com
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
XApiKey: your-api-key-here
```

### Response

#### Success Response (200 OK)

**Description**: File URL retrieved successfully from SharePoint

**Headers**:
```http
Content-Type: application/json
```

**Body**:
```json
{
  "success": true,
  "data": {
    "url": "https://graph.microsoft.com/v1.0/drives/b!xyz123/items/01ABCDEF12345GHIJ67890KLMNO/content?download=1&expires=2025-12-24T14:30:00Z&signature=abc...",
    "expiresAt": "2025-12-24T14:30:00Z",
    "contentType": "image/jpeg",
    "fileName": "857c71eb-dd51-4e9f-9b49-29c02df1f04f_20251224024128_cb03fc.jpg",
    "size": 2048576
  },
  "message": "File URL retrieved successfully"
}
```

**Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `success` | boolean | Always `true` for successful responses |
| `data.url` | string | Signed/temporary URL from Microsoft Graph API for downloading the file |
| `data.expiresAt` | string (ISO 8601) | UTC timestamp when the signed URL expires |
| `data.contentType` | string | MIME type of the file (e.g., "image/jpeg", "application/pdf") |
| `data.fileName` | string | Original filename for display or download |
| `data.size` | number | File size in bytes |
| `message` | string | Human-readable success message |

#### Error Responses

##### 400 Bad Request - Invalid IdRef Format

**Description**: The IdRef parameter is missing, empty, or has invalid format

**Body**:
```json
{
  "success": false,
  "message": "Invalid IdRef format",
  "errors": [
    "IdRef must be a valid SharePoint item identifier"
  ]
}
```

**Causes**:
- IdRef is null or empty string
- IdRef exceeds 255 characters
- IdRef contains invalid characters (path traversal attempts)

##### 404 Not Found - File Not Found

**Description**: No file exists in SharePoint with the given IdRef

**Body**:
```json
{
  "success": false,
  "message": "File not found in SharePoint",
  "errors": [
    "No file found with IdRef: 01ABCDEF12345GHIJ67890KLMNO"
  ]
}
```

**Causes**:
- File was deleted from SharePoint
- IdRef is valid format but doesn't reference an existing file
- File is in a different SharePoint site/drive

##### 403 Forbidden - Access Denied

**Description**: User does not have permission to access the file

**Body**:
```json
{
  "success": false,
  "message": "Access denied",
  "errors": [
    "User does not have permission to access this file"
  ]
}
```

**Causes**:
- User lacks permission to view the parent activity
- File access was revoked in SharePoint
- API key or JWT token invalid/expired

##### 504 Gateway Timeout - SharePoint Service Timeout

**Description**: Microsoft Graph API did not respond within the timeout period

**Body**:
```json
{
  "success": false,
  "message": "Service timeout",
  "errors": [
    "SharePoint service did not respond in time"
  ]
}
```

**Causes**:
- SharePoint API is experiencing downtime
- Network issues between CRM API and Microsoft Graph
- Graph API throttling/rate limiting

##### 429 Too Many Requests - Rate Limit Exceeded

**Description**: Microsoft Graph API rate limit exceeded (unlikely but possible)

**Body**:
```json
{
  "success": false,
  "message": "Too many requests",
  "errors": [
    "Service is busy. Please try again later."
  ]
}
```

**Causes**:
- Graph API throttling threshold exceeded
- Too many concurrent file retrieval requests

##### 500 Internal Server Error - Unexpected Error

**Description**: An unexpected error occurred on the server

**Body**:
```json
{
  "success": false,
  "message": "An error occurred while retrieving the file URL",
  "errors": [
    "Internal server error"
  ]
}
```

**Causes**:
- Unhandled exception in FileRetrievalService
- SharePoint service configuration error
- Database connection failure

## Security

### Authorization

- **JWT Token Validation**: Bearer token must be valid and not expired
- **API Key Validation**: XApiKey header must match configured API key
- **User Permission Check**: (Future enhancement) Verify user has access to parent activity before returning file URL

### IdRef Validation

- **Format Check**: Must be alphanumeric with hyphens/underscores, max 255 chars
- **Injection Prevention**: Validate format to prevent path traversal or SQL injection attempts

### Audit Logging

All file retrieval attempts are logged with the following information:
```
[2025-12-24 13:30:00] [INFO] [User: john.doe@example.com] Requested file 01ABCDEF12345GHIJ67890KLMNO - Success
[2025-12-24 13:31:00] [ERROR] [User: jane.smith@example.com] Requested file 99INVALID99 - Failure: File not found
```

**Log Fields**:
- Timestamp (UTC)
- User email (from JWT)
- IdRef requested
- Success/Failure status
- Error reason (if failed)

### URL Expiration

- Signed URLs returned by Microsoft Graph API expire in **approximately 1 hour**
- Frontend should NOT cache URLs beyond expiration time
- User can continue viewing already-loaded file after expiration (URL already in browser)
- Navigating to a different file and back will require a new API call

## Rate Limiting

**CRM API Level**: No rate limiting implemented in MVP

**Microsoft Graph API Level**: Subject to Microsoft's throttling policies (varies by tenant)

**Recommendation**: Implement client-side throttling if frequent "429 Too Many Requests" errors occur

## Caching

**Server-Side**: No caching in MVP (fetch from Graph API on every request)

**Client-Side**: Not implemented in MVP (future enhancement: cache signed URLs in localStorage with expiration check)

## Examples

### Example 1: Successful Image File Retrieval

**Request**:
```bash
curl -X GET "https://api-crm.local.com/api/files/01ABCDEF12345GHIJ67890KLMNO" \
  -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "XApiKey: your-api-key-here"
```

**Response** (200 OK):
```json
{
  "success": true,
  "data": {
    "url": "https://graph.microsoft.com/v1.0/drives/b!xyz123/items/01ABCDEF12345GHIJ67890KLMNO/content?download=1&expires=2025-12-24T14:30:00Z&signature=abc...",
    "expiresAt": "2025-12-24T14:30:00Z",
    "contentType": "image/jpeg",
    "fileName": "screenshot.jpg",
    "size": 2048576
  },
  "message": "File URL retrieved successfully"
}
```

**Frontend Usage**:
```javascript
const response = await filesApi.getFileUrl('01ABCDEF12345GHIJ67890KLMNO');
const signedUrl = response.data.data.url;
// Load in <img src={signedUrl} />
```

### Example 2: File Not Found

**Request**:
```bash
curl -X GET "https://api-crm.local.com/api/files/INVALID_ID_REF" \
  -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "XApiKey: your-api-key-here"
```

**Response** (404 Not Found):
```json
{
  "success": false,
  "message": "File not found in SharePoint",
  "errors": [
    "No file found with IdRef: INVALID_ID_REF"
  ]
}
```

**Frontend Handling**:
```javascript
try {
  const response = await filesApi.getFileUrl('INVALID_ID_REF');
} catch (error) {
  if (error.response?.status === 404) {
    showError("File not found. It may have been deleted.");
  }
}
```

### Example 3: Access Denied

**Request**:
```bash
curl -X GET "https://api-crm.local.com/api/files/01PROTECTED_FILE" \
  -H "Authorization: Bearer <expired_or_invalid_token>" \
  -H "XApiKey: your-api-key-here"
```

**Response** (403 Forbidden):
```json
{
  "success": false,
  "message": "Access denied",
  "errors": [
    "User does not have permission to access this file"
  ]
}
```

**Frontend Handling**:
```javascript
try {
  const response = await filesApi.getFileUrl('01PROTECTED_FILE');
} catch (error) {
  if (error.response?.status === 403) {
    showError("You don't have permission to view this file.");
  }
}
```

## Integration Notes

### Frontend Integration

**API Client** (`src/infrastructure/api/filesApi.js`):
```javascript
import axiosInstance from "./axiosInstance";

const filesApi = {
  getFileUrl: (idRef) => axiosInstance.get(`/files/${idRef}`),
};

export default filesApi;
```

**Usage in Components**:
```javascript
import filesApi from '../../../../infrastructure/api/filesApi';

// Inside preview modal
const fetchSignedUrl = async (idRef) => {
  try {
    const response = await filesApi.getFileUrl(idRef);
    return response.data.data.url; // Extract from ApiResponse wrapper
  } catch (error) {
    console.error('Failed to fetch file URL:', error);
    throw error;
  }
};
```

### Backend Implementation

**Controller** (`src/CRM.Api/Controllers/FilesController.cs`):
```csharp
[Authorize]
[ApiController]
[Route("api/files")]
public class FilesController : ControllerBase
{
    private readonly IFileRetrievalService _fileService;

    [HttpGet("{idRef}")]
    public async Task<IActionResult> GetFileUrl(string idRef, CancellationToken ct)
    {
        var result = await _fileService.GetFileUrlAsync(idRef, ct);
        return Ok(ApiResponse<FileUrlResponse>.Ok(result, "File URL retrieved successfully"));
    }
}
```

## Versioning

**Current Version**: 1.0

**Future Enhancements** (not in MVP):
- Add optional `?download=true` query parameter to force download instead of inline display
- Add file access permission check against activity ownership
- Implement response caching with 50-minute TTL
- Add batch endpoint: `POST /api/files/batch` for fetching multiple URLs
- Return thumbnail URL in addition to full file URL

## Testing

### Manual Testing Checklist

- [ ] Valid IdRef returns 200 with signed URL
- [ ] Invalid IdRef format returns 400
- [ ] Non-existent IdRef returns 404
- [ ] Missing Authorization header returns 401
- [ ] Expired JWT token returns 401
- [ ] Invalid API key returns 403
- [ ] Signed URL actually works (can load file in browser)
- [ ] Audit log entry created for each request
- [ ] Error responses match documented format

### Integration Testing

- [ ] End-to-end flow: Click preview → API call → File loads in modal
- [ ] Error handling: Delete file from SharePoint → 404 error shown in UI
- [ ] Backward compatibility: Direct URL attachments still work
- [ ] Navigation: Preview file → Next file → Correct signed URL fetched

## Changelog

**Version 1.0** (2025-12-24):
- Initial API contract for SharePoint file preview fix
- Supports GET /api/files/{idRef} endpoint
- Returns signed URLs from Microsoft Graph API
- Error handling for 400, 403, 404, 429, 504, 500 status codes
